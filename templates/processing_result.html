<!-- templates/processing_result.html -->
{% extends "base.html" %} {% block title %}Processing Results{% endblock %} {%
block content %}
<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h3 class="card-title mb-0">âœ“ Data Processing Complete</h3>
      </div>
      <div class="card-body">
        <p class="lead">
          File <strong>{{ filename }}</strong> has been successfully processed
          and analyzed.
        </p>

        <!-- Summary Statistics -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-primary">
                ${{ "{:,.2f}".format(processing.summary_stats.total_revenue) }}
              </h4>
              <p class="text-muted">Total Revenue</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-success">
                {{ processing.summary_stats.total_customers }}
              </h4>
              <p class="text-muted">Total Customers</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-info">
                {{ processing.summary_stats.total_transactions }}
              </h4>
              <p class="text-muted">Transactions</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-warning">
                {{ processing.summary_stats.product_categories }}
              </h4>
              <p class="text-muted">Product Categories</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Analysis Results Tabs -->
<div class="row">
  <div class="col-12">
    <ul class="nav nav-tabs" id="analysisTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="rankings-tab"
          data-bs-toggle="tab"
          data-bs-target="#rankings"
          type="button"
          role="tab"
        >
          Customer Rankings
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="categories-tab"
          data-bs-toggle="tab"
          data-bs-target="#categories"
          type="button"
          role="tab"
        >
          Category Analysis
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="address-tab"
          data-bs-toggle="tab"
          data-bs-target="#address"
          type="button"
          role="tab"
        >
          Address History
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="insights-tab"
          data-bs-toggle="tab"
          data-bs-target="#insights"
          type="button"
          role="tab"
        >
          Business Insights
        </button>
      </li>
    </ul>

    <div class="tab-content" id="analysisTabContent">
      <!-- Customer Rankings Tab -->
      <div class="tab-pane fade show active" id="rankings" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Top 10 Customers by Total Spending</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Customer ID</th>
                    <th>Total Spent</th>
                    <th>Transactions</th>
                    <th>Segment</th>
                  </tr>
                </thead>
                <tbody>
                  {% for customer in
                  processing.analysis_results.customer_rankings.top_10_customers
                  %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ customer.customer_id }}</td>
                    <td>${{ "{:,.2f}".format(customer.total_spent) }}</td>
                    <td>{{ customer.transaction_count }}</td>
                    <td>
                      <span
                        class="badge bg-{% if customer.customer_segment == 'VIP' %}danger{% elif customer.customer_segment == 'High Value' %}warning{% elif customer.customer_segment == 'Medium Value' %}info{% else %}secondary{% endif %}"
                      >
                        {{ customer.customer_segment }}
                      </span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="row mt-4">
              <div class="col-md-6">
                <h6>Customer Segments Distribution</h6>
                {% for segment, count in
                processing.analysis_results.customer_rankings.summary_stats.customer_segments.items()
                %}
                <div class="d-flex justify-content-between">
                  <span>{{ segment }}:</span>
                  <strong>{{ count }} customers</strong>
                </div>
                {% endfor %}
              </div>
              <div class="col-md-6">
                <h6>Revenue Statistics</h6>
                <div class="d-flex justify-content-between">
                  <span>Average Customer Value:</span>
                  <strong
                    >${{
                    "{:,.2f}".format(processing.analysis_results.customer_rankings.summary_stats.average_customer_value)
                    }}</strong
                  >
                </div>
                <div class="d-flex justify-content-between">
                  <span>Median Customer Value:</span>
                  <strong
                    >${{
                    "{:,.2f}".format(processing.analysis_results.customer_rankings.summary_stats.median_customer_value)
                    }}</strong
                  >
                </div>
                <div class="d-flex justify-content-between">
                  <span>Top 10% Revenue Share:</span>
                  <strong
                    >{{
                    "{:.1f}".format(processing.analysis_results.customer_rankings.summary_stats.top_10_percent_revenue_share)
                    }}%</strong
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Analysis Tab -->
      <div class="tab-pane fade" id="categories" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Top Spenders by Product Category</h5>
            <div class="row">
              {% for category, spender in
              processing.analysis_results.top_spenders_by_category.items() %}
              <div class="col-md-6 mb-3">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <strong>{{ category }}</strong>
                  </div>
                  <div class="card-body">
                    <p>
                      <strong>Top Customer:</strong> {{ spender.customer_id }}
                    </p>
                    <p>
                      <strong>Amount Spent:</strong> ${{
                      "{:,.2f}".format(spender.amount_spent) }}
                    </p>
                    <p>
                      <strong>Category Share:</strong> {{
                      "{:.1f}".format(spender.percentage_of_category) }}%
                    </p>
                    <p>
                      <strong>Total Spending:</strong> ${{
                      "{:,.2f}".format(spender.total_spending_all_categories) }}
                    </p>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <h6 class="mt-4">Category Performance Summary</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Total Revenue</th>
                    <th>Customers</th>
                    <th>Avg Spending</th>
                    <th>Max Spending</th>
                  </tr>
                </thead>
                <tbody>
                  {% for category, stats in
                  processing.analysis_results.customer_category_totals.category_summary.items()
                  %}
                  <tr>
                    <td>{{ category }}</td>
                    <td>${{ "{:,.2f}".format(stats.total_revenue) }}</td>
                    <td>{{ stats.customers_purchased }}</td>
                    <td>${{ "{:,.2f}".format(stats.average_spending) }}</td>
                    <td>${{ "{:,.2f}".format(stats.max_spending) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Address History Tab -->
      <div class="tab-pane fade" id="address" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Customer Address Analysis</h5>

            <div class="row mb-4">
              <div class="col-md-4">
                <div class="text-center">
                  <h4 class="text-info">
                    {{
                    processing.analysis_results.address_history.summary.total_customers_tracked
                    }}
                  </h4>
                  <p class="text-muted">Customers Tracked</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h4 class="text-warning">
                    {{
                    processing.analysis_results.address_history.summary.customers_with_potential_changes
                    }}
                  </h4>
                  <p class="text-muted">Long-term Customers (365+ days)</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h4 class="text-success">
                    {{
                    "{:.0f}".format(processing.analysis_results.address_history.summary.average_days_at_address)
                    }}
                  </h4>
                  <p class="text-muted">Avg Days Active</p>
                </div>
              </div>
            </div>

            {% if
            processing.analysis_results.address_history.summary.long_term_customers
            %}
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6>Long-term Customers (Potential Address Changes)</h6>
              <div class="btn-group" role="group">
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary active"
                  id="showTop20Btn"
                  onclick="showTop20()"
                >
                  Top 20
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  id="showAllBtn"
                  onclick="showAllCustomers()"
                >
                  View All ({{
                  processing.analysis_results.address_history.summary.long_term_customers|length
                  }})
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-success"
                  onclick="downloadAddressHistory()"
                >
                  <i class="fas fa-download"></i> Download CSV
                </button>
              </div>
            </div>

            <!-- Top 20 Table (Default View) -->
            <div id="top20Table">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Customer ID</th>
                      <th>Days Active</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for customer in
                    processing.analysis_results.address_history.summary.long_term_customers[:20]
                    %}
                    <tr>
                      <td>{{ customer.customer_id }}</td>
                      <td>{{ customer.days_active }}</td>
                      <td><span class="badge bg-success">Active</span></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if
              processing.analysis_results.address_history.summary.long_term_customers|length
              > 20 %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Showing top 20 of {{
                processing.analysis_results.address_history.summary.long_term_customers|length
                }} long-term customers.
                <strong>Click "View All" to see complete list.</strong>
              </div>
              {% endif %}
            </div>

            <!-- All Customers Table (Hidden by Default) -->
            <div id="allCustomersTable" style="display: none">
              <!-- Search and Filter Options -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <input
                    type="text"
                    class="form-control"
                    id="customerSearch"
                    placeholder="Search by Customer ID..."
                    onkeyup="filterCustomers()"
                  />
                </div>
                <div class="col-md-6">
                  <select
                    class="form-control"
                    id="daysFilter"
                    onchange="filterCustomers()"
                  >
                    <option value="">All Activity Levels</option>
                    <option value="365">365+ days</option>
                    <option value="730">2+ years</option>
                    <option value="1095">3+ years</option>
                  </select>
                </div>
              </div>

              <div
                class="table-responsive"
                style="max-height: 600px; overflow-y: auto"
              >
                <table class="table table-striped table-sm">
                  <thead class="sticky-top bg-white">
                    <tr>
                      <th>Customer ID</th>
                      <th>Days Active</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="allCustomersTableBody">
                    {% for customer in
                    processing.analysis_results.address_history.summary.long_term_customers
                    %}
                    <tr>
                      <td>{{ customer.customer_id }}</td>
                      <td>{{ customer.days_active }}</td>
                      <td><span class="badge bg-success">Active</span></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                Showing all {{
                processing.analysis_results.address_history.summary.long_term_customers|length
                }} long-term customers.
              </div>
            </div>

            {% else %}
            <div class="alert alert-info">
              <strong>Note:</strong> No customers with extended activity periods
              (365+ days) detected in this dataset.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Business Insights Tab -->
      <div class="tab-pane fade" id="insights" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Business Insights & Recommendations</h5>

            <!-- Key Metrics -->
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5>Revenue Insights</h5>
                    <p>
                      <strong>Avg Transaction:</strong> ${{
                      "{:.2f}".format(insights.revenue_insights.average_transaction_value)
                      }}
                    </p>
                    <p>
                      <strong>Revenue per Customer:</strong> ${{
                      "{:.2f}".format(insights.revenue_insights.revenue_per_customer)
                      }}
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5>Customer Insights</h5>
                    <p>
                      <strong>Retention Period:</strong> {{
                      "{:.0f}".format(insights.customer_insights.customer_retention_period)
                      }} days
                    </p>
                    <p>
                      <strong>Most Valuable Segment:</strong>
                      {% set max_segment =
                      insights.customer_insights.most_valuable_segment.keys() |
                      list | first %} {{ max_segment }}
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5>Product Insights</h5>
                    <p>
                      <strong>Categories:</strong> {{
                      insights.product_insights.category_performance.keys() |
                      list | length }}
                    </p>
                    <p>
                      <strong>Top Category:</strong>
                      {% set top_category =
                      insights.product_insights.category_performance.items() |
                      list | sort(attribute='1.total_revenue', reverse=true) |
                      first %} {{ top_category[0] }}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recommendations -->
            <h6>Strategic Recommendations</h6>
            {% for recommendation in insights.recommendations %}
            <div
              class="alert alert-{% if recommendation.priority == 'High' %}danger{% elif recommendation.priority == 'Medium' %}warning{% else %}info{% endif %}"
              role="alert"
            >
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="alert-heading">
                    {{ recommendation.type }} - {{ recommendation.category }}
                  </h6>
                  <p class="mb-1">{{ recommendation.recommendation }}</p>
                  <small class="text-muted"
                    >Potential Impact: {{ recommendation.potential_impact
                    }}</small
                  >
                </div>
                <span
                  class="badge bg-{% if recommendation.priority == 'High' %}danger{% elif recommendation.priority == 'Medium' %}warning{% else %}info{% endif %}"
                >
                  {{ recommendation.priority }}
                </span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
  <div class="col-12">
    <div class="d-flex gap-2">
      <a href="{{ url_for('index') }}" class="btn btn-primary"
        >Upload Another File</a
      >
      <a href="{{ url_for('view_logs') }}" class="btn btn-secondary"
        >View Upload History</a
      >
      <button class="btn btn-info" onclick="downloadProcessedData()">
        Download Processed Data
      </button>
    </div>
  </div>
</div>

<script>
  function showTop20() {
    document.getElementById("top20Table").style.display = "block";
    document.getElementById("allCustomersTable").style.display = "none";

    // Update button states
    document.getElementById("showTop20Btn").classList.add("active");
    document.getElementById("showAllBtn").classList.remove("active");
  }

  function showAllCustomers() {
    document.getElementById("top20Table").style.display = "none";
    document.getElementById("allCustomersTable").style.display = "block";

    // Update button states
    document.getElementById("showTop20Btn").classList.remove("active");
    document.getElementById("showAllBtn").classList.add("active");
  }

  function filterCustomers() {
    const searchTerm = document
      .getElementById("customerSearch")
      .value.toLowerCase();
    const daysFilter = document.getElementById("daysFilter").value;
    const table = document.getElementById("allCustomersTableBody");
    const rows = table.getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
      const customerIdCell = rows[i].getElementsByTagName("td")[0];
      const daysActiveCell = rows[i].getElementsByTagName("td")[1];

      if (customerIdCell && daysActiveCell) {
        const customerId = customerIdCell.textContent.toLowerCase();
        const daysActive = parseInt(daysActiveCell.textContent);

        let showRow = true;

        // Apply search filter
        if (searchTerm && !customerId.includes(searchTerm)) {
          showRow = false;
        }

        // Apply days filter
        if (daysFilter && daysActive < parseInt(daysFilter)) {
          showRow = false;
        }

        rows[i].style.display = showRow ? "" : "none";
      }
    }
  }

  function downloadAddressHistory() {
    // Generate CSV content
    const rows = [["Customer ID", "Days Active", "Status"]];

    // Get all customer data from the table
    const table = document.getElementById("allCustomersTableBody");
    const tableRows = table.getElementsByTagName("tr");

    for (let i = 0; i < tableRows.length; i++) {
      const cells = tableRows[i].getElementsByTagName("td");
      if (cells.length >= 3) {
        rows.push([
          cells[0].textContent.trim(),
          cells[1].textContent.trim(),
          cells[2].textContent.trim(),
        ]);
      }
    }

    // Create CSV content
    const csvContent = rows
      .map((row) => row.map((cell) => `"${cell}"`).join(","))
      .join("\n");

    // Create and download file
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "address_history_{{ filename }}.csv";
    a.click();

    window.URL.revokeObjectURL(url);
  }

  function downloadProcessedData() {
    // This will be implemented in step 6
    alert("Download functionality will be implemented in step 6");
  }
</script>
{% endblock %}

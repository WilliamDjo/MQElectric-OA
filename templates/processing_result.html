<!-- templates/processing_result.html -->
{% extends "base.html" %} {% block title %}Processing Results{% endblock %} {%
block content %}
<div class="row">
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h3 class="card-title mb-0">✓ Data Processing Complete</h3>
      </div>
      <div class="card-body">
        <p class="lead">
          File <strong>{{ filename }}</strong> has been successfully processed
          and analyzed.
        </p>

        <!-- Summary Statistics -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-primary">
                ${{ "{:,.2f}".format(processing.summary_stats.total_revenue) }}
              </h4>
              <p class="text-muted">Total Revenue</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-success">
                {{ processing.summary_stats.total_customers }}
              </h4>
              <p class="text-muted">Total Customers</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <h4 class="text-info">
                {{ processing.summary_stats.total_transactions }}
              </h4>
              <p class="text-muted">Transactions</p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              {% if processing.summary_stats.geocoded_customers %}
              <h4 class="text-warning">
                {{ processing.summary_stats.geocoded_customers }}
              </h4>
              <p class="text-muted">Geocoded Customers</p>
              {% else %}
              <h4 class="text-warning">
                {{ processing.summary_stats.product_categories }}
              </h4>
              <p class="text-muted">Product Categories</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Analysis Results Tabs -->
<div class="row">
  <div class="col-12">
    <ul class="nav nav-tabs" id="analysisTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="rankings-tab"
          data-bs-toggle="tab"
          data-bs-target="#rankings"
          type="button"
          role="tab"
        >
          Customer Rankings
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="categories-tab"
          data-bs-toggle="tab"
          data-bs-target="#categories"
          type="button"
          role="tab"
        >
          Category Analysis
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="address-tab"
          data-bs-toggle="tab"
          data-bs-target="#address"
          type="button"
          role="tab"
        >
          Address History
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="geolocation-tab"
          data-bs-toggle="tab"
          data-bs-target="#geolocation"
          type="button"
          role="tab"
        >
          Geolocation
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="insights-tab"
          data-bs-toggle="tab"
          data-bs-target="#insights"
          type="button"
          role="tab"
        >
          Business Insights
        </button>
      </li>
    </ul>

    <div class="tab-content" id="analysisTabContent">
      <!-- Customer Rankings Tab -->
      <div class="tab-pane fade show active" id="rankings" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Top 10 Customers by Total Spending</h5>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Customer ID</th>
                    <th>Total Spent</th>
                    <th>Transactions</th>
                    <th>Segment</th>
                  </tr>
                </thead>
                <tbody>
                  {% for customer in
                  processing.analysis_results.customer_rankings.top_10_customers
                  %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ customer.customer_id }}</td>
                    <td>${{ "{:,.2f}".format(customer.total_spent) }}</td>
                    <td>{{ customer.transaction_count }}</td>
                    <td>
                      <span
                        class="badge bg-{% if customer.customer_segment == 'VIP' %}danger{% elif customer.customer_segment == 'High Value' %}warning{% elif customer.customer_segment == 'Medium Value' %}info{% else %}secondary{% endif %}"
                      >
                        {{ customer.customer_segment }}
                      </span>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="row mt-4">
              <div class="col-md-6">
                <h6>Customer Segments Distribution</h6>
                {% for segment, count in
                processing.analysis_results.customer_rankings.summary_stats.customer_segments.items()
                %}
                <div class="d-flex justify-content-between">
                  <span>{{ segment }}:</span>
                  <strong>{{ count }} customers</strong>
                </div>
                {% endfor %}
              </div>
              <div class="col-md-6">
                <h6>Revenue Statistics</h6>
                <div class="d-flex justify-content-between">
                  <span>Average Customer Value:</span>
                  <strong
                    >${{
                    "{:,.2f}".format(processing.analysis_results.customer_rankings.summary_stats.average_customer_value)
                    }}</strong
                  >
                </div>
                <div class="d-flex justify-content-between">
                  <span>Median Customer Value:</span>
                  <strong
                    >${{
                    "{:,.2f}".format(processing.analysis_results.customer_rankings.summary_stats.median_customer_value)
                    }}</strong
                  >
                </div>
                <div class="d-flex justify-content-between">
                  <span>Top 10% Revenue Share:</span>
                  <strong
                    >{{
                    "{:.1f}".format(processing.analysis_results.customer_rankings.summary_stats.top_10_percent_revenue_share)
                    }}%</strong
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Analysis Tab -->
      <div class="tab-pane fade" id="categories" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Top Spenders by Product Category</h5>
            <div class="row">
              {% for category, spender in
              processing.analysis_results.top_spenders_by_category.items() %}
              <div class="col-md-6 mb-3">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <strong>{{ category }}</strong>
                  </div>
                  <div class="card-body">
                    <p>
                      <strong>Top Customer:</strong> {{ spender.customer_id }}
                    </p>
                    <p>
                      <strong>Amount Spent:</strong> ${{
                      "{:,.2f}".format(spender.amount_spent) }}
                    </p>
                    <p>
                      <strong>Category Share:</strong> {{
                      "{:.1f}".format(spender.percentage_of_category) }}%
                    </p>
                    <p>
                      <strong>Total Spending:</strong> ${{
                      "{:,.2f}".format(spender.total_spending_all_categories) }}
                    </p>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <h6 class="mt-4">Category Performance Summary</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Total Revenue</th>
                    <th>Customers</th>
                    <th>Avg Spending</th>
                    <th>Max Spending</th>
                  </tr>
                </thead>
                <tbody>
                  {% for category, stats in
                  processing.analysis_results.customer_category_totals.category_summary.items()
                  %}
                  <tr>
                    <td>{{ category }}</td>
                    <td>${{ "{:,.2f}".format(stats.total_revenue) }}</td>
                    <td>{{ stats.customers_purchased }}</td>
                    <td>${{ "{:,.2f}".format(stats.average_spending) }}</td>
                    <td>${{ "{:,.2f}".format(stats.max_spending) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Address History Tab -->
      <div class="tab-pane fade" id="address" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Customer Address Analysis</h5>

            <div class="row mb-4">
              <div class="col-md-4">
                <div class="text-center">
                  <h4 class="text-info">
                    {{
                    processing.analysis_results.address_history.summary.total_customers_tracked
                    }}
                  </h4>
                  <p class="text-muted">Customers Tracked</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h4 class="text-warning">
                    {{
                    processing.analysis_results.address_history.summary.customers_with_potential_changes
                    }}
                  </h4>
                  <p class="text-muted">Long-term Customers (365+ days)</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h4 class="text-success">
                    {{
                    "{:.0f}".format(processing.analysis_results.address_history.summary.average_days_at_address)
                    }}
                  </h4>
                  <p class="text-muted">Avg Days Active</p>
                </div>
              </div>
            </div>

            {% if
            processing.analysis_results.address_history.summary.long_term_customers
            %}
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6>Long-term Customers (Potential Address Changes)</h6>
              <div class="btn-group" role="group">
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary active"
                  id="showTop20Btn"
                  onclick="showTop20()"
                >
                  Top 20
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  id="showAllBtn"
                  onclick="showAllCustomers()"
                >
                  View All ({{
                  processing.analysis_results.address_history.summary.long_term_customers|length
                  }})
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-success"
                  onclick="downloadAddressHistory()"
                >
                  <i class="fas fa-download"></i> Download CSV
                </button>
              </div>
            </div>

            <!-- Top 20 Table (Default View) -->
            <div id="top20Table">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Customer ID</th>
                      <th>Days Active</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for customer in
                    processing.analysis_results.address_history.summary.long_term_customers[:20]
                    %}
                    <tr>
                      <td>{{ customer.customer_id }}</td>
                      <td>{{ customer.days_active }}</td>
                      <td><span class="badge bg-success">Active</span></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if
              processing.analysis_results.address_history.summary.long_term_customers|length
              > 20 %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Showing top 20 of {{
                processing.analysis_results.address_history.summary.long_term_customers|length
                }} long-term customers.
                <strong>Click "View All" to see complete list.</strong>
              </div>
              {% endif %}
            </div>

            <!-- All Customers Table (Hidden by Default) -->
            <div id="allCustomersTable" style="display: none">
              <!-- Search and Filter Options -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <input
                    type="text"
                    class="form-control"
                    id="customerSearch"
                    placeholder="Search by Customer ID..."
                    onkeyup="filterCustomers()"
                  />
                </div>
                <div class="col-md-6">
                  <select
                    class="form-control"
                    id="daysFilter"
                    onchange="filterCustomers()"
                  >
                    <option value="">All Activity Levels</option>
                    <option value="365">365+ days</option>
                    <option value="730">2+ years</option>
                    <option value="1095">3+ years</option>
                  </select>
                </div>
              </div>

              <div
                class="table-responsive"
                style="max-height: 600px; overflow-y: auto"
              >
                <table class="table table-striped table-sm">
                  <thead class="sticky-top bg-white">
                    <tr>
                      <th>Customer ID</th>
                      <th>Days Active</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="allCustomersTableBody">
                    {% for customer in
                    processing.analysis_results.address_history.summary.long_term_customers
                    %}
                    <tr>
                      <td>{{ customer.customer_id }}</td>
                      <td>{{ customer.days_active }}</td>
                      <td><span class="badge bg-success">Active</span></td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                Showing all {{
                processing.analysis_results.address_history.summary.long_term_customers|length
                }} long-term customers.
              </div>
            </div>

            {% else %}
            <div class="alert alert-info">
              <strong>Note:</strong> No customers with extended activity periods
              (365+ days) detected in this dataset.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Geolocation Tab -->
      <div class="tab-pane fade" id="geolocation" role="tabpanel">
        <div class="card">
          <div class="card-body">
            {% if processing.analysis_results.geolocation_insights %}
            <h5 class="card-title">Customer Geolocation Analysis</h5>

            <!-- Geolocation Summary Stats -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="text-center">
                  <h4 class="text-success">
                    {{
                    processing.analysis_results.geolocation_insights.geocoding_stats.geocoded_customers
                    }}
                  </h4>
                  <p class="text-muted">Geocoded Customers</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h4 class="text-info">
                    {{
                    "{:.1f}".format(processing.analysis_results.geolocation_insights.geocoding_stats.geocoding_success_rate)
                    }}%
                  </h4>
                  <p class="text-muted">Success Rate</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h4 class="text-warning">
                    {{
                    processing.analysis_results.geolocation_insights.geocoding_stats.cached_results
                    }}
                  </h4>
                  <p class="text-muted">Cached Results</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h4 class="text-primary">
                    {{
                    processing.analysis_results.geolocation_insights.geocoding_stats.geocoded_customers
                    -
                    processing.analysis_results.geolocation_insights.geocoding_stats.cached_results
                    }}
                  </h4>
                  <p class="text-muted">New API Calls</p>
                </div>
              </div>
            </div>

            <!-- Geographic Center -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6>Geographic Center</h6>
                    <p>
                      <strong>Latitude:</strong> {{
                      "{:.6f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.center_latitude)
                      }}
                    </p>
                    <p>
                      <strong>Longitude:</strong> {{
                      "{:.6f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.center_longitude)
                      }}
                    </p>
                    <p>
                      <small class="text-muted"
                        >Average center point of all customer locations</small
                      >
                    </p>

                    <!-- ADD: Google Maps Link -->
                    <a
                      href="https://www.google.com/maps?q={{ processing.analysis_results.geolocation_insights.geographic_distribution.center_latitude }},{{ processing.analysis_results.geolocation_insights.geographic_distribution.center_longitude }}"
                      target="_blank"
                      class="btn btn-sm btn-outline-primary"
                    >
                      <i class="fas fa-external-link-alt"></i> View on Google
                      Maps
                    </a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6>Geographic Spread</h6>
                    <p>
                      <strong>Lat Range:</strong> {{
                      "{:.4f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.latitude_range.min)
                      }} to {{
                      "{:.4f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.latitude_range.max)
                      }}
                    </p>
                    <p>
                      <strong>Lng Range:</strong> {{
                      "{:.4f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.longitude_range.min)
                      }} to {{
                      "{:.4f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.longitude_range.max)
                      }}
                    </p>
                    <p>
                      <small class="text-muted"
                        >Geographic boundaries of customer base</small
                      >
                    </p>

                    <!-- ADD: Coverage Area Calculation -->
                    {% set lat_diff =
                    processing.analysis_results.geolocation_insights.geographic_distribution.latitude_range.max
                    -
                    processing.analysis_results.geolocation_insights.geographic_distribution.latitude_range.min
                    %} {% set lng_diff =
                    processing.analysis_results.geolocation_insights.geographic_distribution.longitude_range.max
                    -
                    processing.analysis_results.geolocation_insights.geographic_distribution.longitude_range.min
                    %}
                    <p>
                      <strong>Coverage Area:</strong> ~{{
                      "{:.0f}".format(lat_diff * lng_diff * 12100) }} km²
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Provider Statistics -->
            {% if
            processing.analysis_results.geolocation_insights.provider_stats %}
            <h6>Geocoding Provider Statistics</h6>
            <div class="row mb-4">
              {% for provider, count in
              processing.analysis_results.geolocation_insights.provider_stats.items()
              %}
              <div class="col-md-4 mb-2">
                <div class="card">
                  <div class="card-body text-center py-2">
                    {% if provider == 'nominatim' %}
                    <i class="fas fa-map text-info"></i>
                    <strong>OpenStreetMap</strong>
                    {% elif provider == 'google' %}
                    <i class="fab fa-google text-success"></i>
                    <strong>Google Maps</strong>
                    {% else %}
                    <i class="fas fa-globe text-secondary"></i>
                    <strong>{{ provider|title }}</strong>
                    {% endif %}
                    <br />
                    <span class="badge bg-primary">{{ count }} customers</span>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- Interactive Map Placeholder -->
            <div class="card mt-4">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h6 class="mb-0">Customer Location Map</h6>
                <div class="btn-group">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    onclick="showMapInstructions()"
                  >
                    <i class="fas fa-info-circle"></i> Implementation Guide
                  </button>
                  <button
                    class="btn btn-sm btn-outline-success"
                    onclick="downloadGeocodedData()"
                  >
                    <i class="fas fa-download"></i> Download KML
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div
                  id="customerMap"
                  style="
                    height: 400px;
                    background-color: #f8f9fa;
                    border: 1px dashed #dee2e6;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                  "
                >
                  <i class="fas fa-map-marked-alt fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">Interactive Map Placeholder</h5>
                  <p class="text-muted text-center">
                    {{
                    processing.analysis_results.geolocation_insights.geocoding_stats.geocoded_customers
                    }} customer locations ready to display<br />
                    <small
                      >Center: {{
                      "{:.4f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.center_latitude)
                      }}, {{
                      "{:.4f}".format(processing.analysis_results.geolocation_insights.geographic_distribution.center_longitude)
                      }}</small
                    >
                  </p>
                </div>
              </div>
            </div>

            <!-- FIXED: Sample Geocoded Customers with Real Data Structure -->
            <div class="row mt-4">
              <div class="col-md-8">
                <h6>Sample Geocoded Customer Locations</h6>
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Customer ID</th>
                        <th>City/Area</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Provider</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if processing.sample_data.geocoded_customers %} {% for
                      customer in processing.sample_data.geocoded_customers %}
                      <tr>
                        <td>{{ customer.customer_id }}</td>
                        <td>
                          {% if customer.normalized_address %} {{
                          customer.normalized_address.split(',')[1]|trim if ','
                          in customer.normalized_address else
                          customer.address.split(',')[1]|trim if ',' in
                          customer.address else 'Unknown' }} {% else %} {{
                          customer.address.split(',')[1]|trim if ',' in
                          customer.address else 'Unknown' }} {% endif %}
                        </td>
                        <td>{{ "{:.4f}".format(customer.latitude) }}</td>
                        <td>{{ "{:.4f}".format(customer.longitude) }}</td>
                        <td>
                          {% if customer.geo_provider == 'nominatim' %}
                          <span class="badge bg-info">OpenStreetMap</span>
                          {% elif customer.geo_provider == 'google' %}
                          <span class="badge bg-success">Google Maps</span>
                          {% else %}
                          <span class="badge bg-secondary"
                            >{{ customer.geo_provider|title }}</span
                          >
                          {% endif %}
                        </td>
                        <td>
                          <a
                            href="https://www.google.com/maps?q={{ customer.latitude }},{{ customer.longitude }}"
                            target="_blank"
                            class="btn btn-xs btn-outline-primary"
                            title="View on Google Maps"
                          >
                            <i class="fas fa-map-pin"></i>
                          </a>
                        </td>
                      </tr>
                      {% endfor %} {% if
                      processing.sample_data.geocoded_customers|length <
                      processing.analysis_results.geolocation_insights.geocoding_stats.geocoded_customers
                      %}
                      <tr class="table-light">
                        <td colspan="6" class="text-center">
                          <small class="text-muted">
                            Showing {{
                            processing.sample_data.geocoded_customers|length }}
                            of {{
                            processing.analysis_results.geolocation_insights.geocoding_stats.geocoded_customers
                            }} geocoded customers
                            <button
                              class="btn btn-xs btn-outline-primary ms-2"
                              onclick="downloadGeocodedCustomers()"
                            >
                              <i class="fas fa-download"></i> Download All
                            </button>
                          </small>
                        </td>
                      </tr>
                      {% endif %} {% else %}
                      <tr class="table-info">
                        <td colspan="6" class="text-center">
                          <i class="fas fa-info-circle"></i>
                          <strong
                            >No geocoded customer data available to
                            display.</strong
                          ><br />
                          <small
                            >This may happen if geolocation was not enabled or
                            if geocoding failed for all addresses.</small
                          >
                        </td>
                      </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-4">
                <h6>Geocoding Quality</h6>
                <div class="card bg-light">
                  <div class="card-body">
                    {% if
                    processing.analysis_results.geolocation_insights.confidence_stats
                    %}
                    <p>
                      <strong>Avg Confidence:</strong> {{
                      "{:.1%}".format(processing.analysis_results.geolocation_insights.confidence_stats.average_confidence)
                      }}
                    </p>
                    <p>
                      <strong>High Confidence:</strong> {{
                      processing.analysis_results.geolocation_insights.confidence_stats.high_confidence_count
                      }} addresses
                    </p>
                    {% endif %}
                    <p>
                      <strong>Total Geocoded:</strong> {{
                      processing.analysis_results.geolocation_insights.geocoding_stats.geocoded_customers
                      }}/{{
                      processing.analysis_results.geolocation_insights.geocoding_stats.total_customers
                      }}
                    </p>

                    <!-- Action Buttons -->
                    <div class="mt-3">
                      <button
                        class="btn btn-sm btn-outline-primary w-100 mb-2"
                        onclick="downloadGeocodedCustomers()"
                      >
                        <i class="fas fa-download"></i> Export Geocoded Data
                      </button>
                      <button
                        class="btn btn-sm btn-outline-info w-100"
                        onclick="showGeolocationSettings()"
                      >
                        <i class="fas fa-cog"></i> Geocoding Settings
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {% else %}
            <!-- Geolocation Not Enabled Message -->
            <div class="alert alert-info">
              <h5>
                <i class="fas fa-info-circle"></i> Geolocation Not Enabled
              </h5>
              <p>
                Geolocation processing was not enabled for this upload. To add
                latitude and longitude coordinates to customer addresses:
              </p>
              <ol>
                <li>Re-upload your file</li>
                <li>Check the "Enable Geolocation" option</li>
                <li>Wait for processing to complete</li>
              </ol>
              <p class="mb-0">
                <small class="text-muted"
                  >Geolocation adds geographic coordinates using free
                  OpenStreetMap or Google Maps APIs.</small
                >
              </p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Business Insights Tab -->
      <div class="tab-pane fade" id="insights" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Business Insights & Recommendations</h5>

            <!-- Key Metrics -->
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5>Revenue Insights</h5>
                    <p>
                      <strong>Avg Transaction:</strong> ${{
                      "{:.2f}".format(insights.revenue_insights.average_transaction_value)
                      }}
                    </p>
                    <p>
                      <strong>Revenue per Customer:</strong> ${{
                      "{:.2f}".format(insights.revenue_insights.revenue_per_customer)
                      }}
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5>Customer Insights</h5>
                    <p>
                      <strong>Retention Period:</strong> {{
                      "{:.0f}".format(insights.customer_insights.customer_retention_period)
                      }} days
                    </p>
                    <p>
                      <strong>Most Valuable Segment:</strong>
                      {% set max_segment =
                      insights.customer_insights.most_valuable_segment.keys() |
                      list | first %} {{ max_segment }}
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5>Product Insights</h5>
                    <p>
                      <strong>Categories:</strong> {{
                      insights.product_insights.category_performance.keys() |
                      list | length }}
                    </p>
                    <p>
                      <strong>Top Category:</strong>
                      {% set top_category =
                      insights.product_insights.category_performance.items() |
                      list | sort(attribute='1.total_revenue', reverse=true) |
                      first %} {{ top_category[0] }}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recommendations -->
            <h6>Strategic Recommendations</h6>
            {% for recommendation in insights.recommendations %}
            <div
              class="alert alert-{% if recommendation.priority == 'High' %}danger{% elif recommendation.priority == 'Medium' %}warning{% else %}info{% endif %}"
              role="alert"
            >
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="alert-heading">
                    {{ recommendation.type }} - {{ recommendation.category }}
                  </h6>
                  <p class="mb-1">{{ recommendation.recommendation }}</p>
                  <small class="text-muted"
                    >Potential Impact: {{ recommendation.potential_impact
                    }}</small
                  >
                </div>
                <span
                  class="badge bg-{% if recommendation.priority == 'High' %}danger{% elif recommendation.priority == 'Medium' %}warning{% else %}info{% endif %}"
                >
                  {{ recommendation.priority }}
                </span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
  <div class="col-12">
    <div class="d-flex gap-2">
      <a href="{{ url_for('index') }}" class="btn btn-primary"
        >Upload Another File</a
      >
      <a href="{{ url_for('view_logs') }}" class="btn btn-secondary"
        >View Upload History</a
      >
      <button class="btn btn-info" onclick="downloadProcessedData()">
        Download Processed Data
      </button>
    </div>
  </div>
</div>

<script>
  function showTop20() {
    document.getElementById("top20Table").style.display = "block";
    document.getElementById("allCustomersTable").style.display = "none";

    // Update button states
    document.getElementById("showTop20Btn").classList.add("active");
    document.getElementById("showAllBtn").classList.remove("active");
  }

  function showAllCustomers() {
    document.getElementById("top20Table").style.display = "none";
    document.getElementById("allCustomersTable").style.display = "block";

    // Update button states
    document.getElementById("showTop20Btn").classList.remove("active");
    document.getElementById("showAllBtn").classList.add("active");
  }

  function filterCustomers() {
    const searchTerm = document
      .getElementById("customerSearch")
      .value.toLowerCase();
    const daysFilter = document.getElementById("daysFilter").value;
    const table = document.getElementById("allCustomersTableBody");
    const rows = table.getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
      const customerIdCell = rows[i].getElementsByTagName("td")[0];
      const daysActiveCell = rows[i].getElementsByTagName("td")[1];

      if (customerIdCell && daysActiveCell) {
        const customerId = customerIdCell.textContent.toLowerCase();
        const daysActive = parseInt(daysActiveCell.textContent);

        let showRow = true;

        // Apply search filter
        if (searchTerm && !customerId.includes(searchTerm)) {
          showRow = false;
        }

        // Apply days filter
        if (daysFilter && daysActive < parseInt(daysFilter)) {
          showRow = false;
        }

        rows[i].style.display = showRow ? "" : "none";
      }
    }
  }

  function downloadAddressHistory() {
    // Generate CSV content
    const rows = [["Customer ID", "Days Active", "Status"]];

    // Get all customer data from the table
    const table = document.getElementById("allCustomersTableBody");
    const tableRows = table.getElementsByTagName("tr");

    for (let i = 0; i < tableRows.length; i++) {
      const cells = tableRows[i].getElementsByTagName("td");
      if (cells.length >= 3) {
        rows.push([
          cells[0].textContent.trim(),
          cells[1].textContent.trim(),
          cells[2].textContent.trim(),
        ]);
      }
    }

    // Create CSV content
    const csvContent = rows
      .map((row) => row.map((cell) => `"${cell}"`).join(","))
      .join("\n");

    // Create and download file
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = window.URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "address_history_{{ filename }}.csv";
    a.click();

    window.URL.revokeObjectURL(url);
  }

  function downloadGeocodedData() {
    alert(
      "KML download would export customer locations for Google Earth/Maps viewing."
    );
  }

  function downloadGeocodedCustomers() {
    // Generate CSV with sample data visible in the table
    const rows = [
      [
        "Customer ID",
        "City/Area",
        "Latitude",
        "Longitude",
        "Provider",
        "Address",
      ],
    ];

    // Get data from the geocoded customers table
    const table = document.querySelector("#geolocation .table tbody");
    const tableRows = table.getElementsByTagName("tr");

    for (let i = 0; i < tableRows.length; i++) {
      const cells = tableRows[i].getElementsByTagName("td");
      if (
        cells.length === 6 &&
        !tableRows[i].classList.contains("table-light") &&
        !tableRows[i].classList.contains("table-info")
      ) {
        rows.push([
          cells[0].textContent.trim(),
          cells[1].textContent.trim(),
          cells[2].textContent.trim(),
          cells[3].textContent.trim(),
          cells[4].textContent.trim(),
          "Full address in complete dataset",
        ]);
      }
    }

    if (rows.length > 1) {
      // Create CSV content
      const csvContent = rows
        .map((row) => row.map((cell) => `"${cell}"`).join(","))
        .join("\n");

      // Create and download file
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "geocoded_customers_sample_{{ filename }}.csv";
      a.click();

      window.URL.revokeObjectURL(url);
    } else {
      alert("No geocoded customer data available to download.");
    }
  }

  function showGeolocationSettings() {
    alert(
      "Settings would show:\n- Geocoding provider preferences\n- Cache statistics\n- API usage limits\n- Quality thresholds"
    );
  }

  function showOnMap(lat, lng) {
    window.open(`https://www.google.com/maps?q=${lat},${lng}`, "_blank");
  }

  function downloadProcessedData() {
    // This will be implemented in step 6
    alert("Download functionality will be implemented in step 6");
  }
</script>
{% endblock %}
